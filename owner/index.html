<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Menu Engine â€” Owner Dashboard</title>
<meta name="theme-color" content="#0B0E13"/>
<style>
  :root{
    --bg:#0B0E13; --panel:#0F141B; --text:#EDEFF3; --muted:#98A2AE; --border:#1A1F27;
    --accent:#00FFD1; --accent-2:#7C4DFF; --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
  .shell{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
  aside{background:linear-gradient(180deg,rgba(11,14,19,.98),rgba(11,14,19,.92));border-right:1px solid var(--border);padding:16px;position:sticky;top:0;height:100vh;overflow:auto}
  main{padding:16px}
  h1{margin:6px 0 16px;font-size:18px;display:flex;align-items:center;gap:8px}
  .logo{width:18px;height:18px;border-radius:6px;background:radial-gradient(circle at 30% 30%,var(--accent),var(--accent-2))}
  .group{border:1px solid var(--border);border-radius:12px;margin-bottom:12px;background:rgba(255,255,255,.03)}
  .group h2{margin:0;padding:10px 12px;font-size:14px;border-bottom:1px solid var(--border);color:#bfe}
  .group .body{padding:10px 12px;display:grid;gap:8px}
  label{font-size:13px;color:var(--muted);display:block}
  input,select,button,textarea{
    width:100%;background:var(--panel);color:var(--text);border:1px solid var(--border);
    padding:8px 10px;border-radius:10px;font-size:14px
  }
  button{cursor:pointer}
  button:hover,select:hover{border-color:var(--accent)}
  .row{display:grid;grid-template-columns: 1fr 1fr;gap:8px}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#83ffe9);color:#00110E;border:none;font-weight:800}
  .btn-ghost{background:var(--panel)}
  .tip{color:var(--muted);font-size:12px}
  /* preview */
  .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
  .panel{border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.03);box-shadow:0 10px 30px rgba(0,0,0,.25)}
  #preview{width:100%;height:calc(100vh - 110px);border:0;border-top:1px solid var(--border);border-radius:0 0 12px 12px;background:#0B0E13}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px dashed #223;padding:6px 8px}
  th{color:#bfe;text-align:left}
  .qrbox{display:flex;align-items:center;gap:10px}
  .qr{width:140px;height:140px;background:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="shell">
  <aside>
    <h1><span class="logo"></span> Owner Dashboard</h1>

    <!-- Data -->
    <div class="group">
      <h2>Data</h2>
      <div class="body">
        <div class="row">
          <button id="loadSampleBtn" class="btn btn-ghost">Load sample</button>
          <input id="jsonFile" type="file" accept=".json,application/json"/>
        </div>
        <div class="row">
          <button id="downloadJsonBtn" class="btn btn-ghost">Download menu.json</button>
          <button id="validateBtn" class="btn btn-ghost">Validate & Clean</button>
        </div>
        <div class="row">
          <button id="clearCacheBtn" class="btn btn-ghost">Clear Cache</button>
          <a href="../engine/index.html" class="btn btn-ghost" target="_blank" rel="noopener">Open Full Preview Â»</a>
        </div>
      </div>
    </div>

    <!-- Brand quick edit -->
    <div class="group">
      <h2>Restaurant</h2>
      <div class="body">
        <div class="row">
          <div><label>Name</label><input id="brandName" placeholder="Restaurant Name"/></div>
          <div><label>Hours</label><input id="brandHours" placeholder="12pmâ€“11pm"/></div>
        </div>
        <div class="row">
          <div><label>Phone</label><input id="brandPhone" placeholder="07182-12345"/></div>
          <div><label>WhatsApp</label><input id="brandWhatsapp" placeholder="919876543210"/></div>
        </div>
        <div><label>Address</label><input id="brandAddress" placeholder="Main Road, Gondia"/></div>
        <button id="renderBtn" class="btn btn-primary">Render</button>
      </div>
    </div>

    <!-- Sections & items -->
    <div class="group">
      <h2>Sections & Items</h2>
      <div class="body">
        <label>Section</label>
        <select id="sectionSelect"></select>
        <table id="itemsTable">
          <thead><tr><th>Item</th><th>Description</th><th>Price</th></tr></thead>
          <tbody></tbody>
        </table>
        <button id="saveItemsBtn" class="btn btn-ghost">Save Items</button>
      </div>
    </div>

    <!-- Bulk price edit -->
    <div class="group">
      <h2>Bulk Price Edit</h2>
      <div class="body">
        <div class="row">
          <div><label>Change (%)</label><input id="bulkPct" type="number" step="1" value="10"/></div>
          <div><label>Round to</label>
            <select id="bulkRound">
              <option value="none">No Rounding</option>
              <option value="1">Nearest â‚¹1</option>
              <option value="5">Nearest â‚¹5</option>
              <option value="10">Nearest â‚¹10</option>
            </select>
          </div>
        </div>
        <button id="applyBulkBtn" class="btn btn-ghost">Apply to current section</button>
        <div class="tip">Tip: Positive = increase, negative = discount (e.g., -10).</div>
      </div>
    </div>

    <!-- CTAs & QR -->
    <div class="group">
      <h2>WhatsApp & Location</h2>
      <div class="body">
        <div><label>Google Maps Link</label><input id="locationLink" placeholder="https://maps.google.com/?q=..."/></div>
        <div class="qrbox">
          <div class="qr" id="qrBox"><canvas id="qrCanvas" width="140" height="140"></canvas></div>
          <div>
            <button id="openWaBtn" class="btn btn-ghost">Open WhatsApp Chat</button><br/>
            <button id="openLocBtn" class="btn btn-ghost">Open Location</button><br/>
            <button id="shareLocBtn" class="btn btn-ghost">Share Location (WA)</button><br/>
            <span class="muted">QR encodes the public menu URL or your Maps link.</span>
          </div>
        </div>
      </div>
    </div>

  </aside>

  <main>
    <div class="bar">
      <label>Template:&nbsp;
        <select id="templateSelect">
          <option value="template-e-fullpage" selected>Template E â€” Full Page</option>
          <option value="template-c-split-two-col">Template C â€” Split Two Column</option>
        </select>
      </label>
      <label>Theme:&nbsp;
        <select id="themeSelect">
          <option value="neon" selected>Neon Night</option>
          <option value="classic">Classic</option>
        </select>
      </label>
      <label>Language:&nbsp;
        <select id="langSelect">
          <option value="en" selected>English</option>
          <option value="hi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
        </select>
      </label>
      <button id="exportHtmlBtn" class="btn btn-ghost">Export HTML</button>
      <button id="exportPdfBtn" class="btn btn-ghost">Export PDF</button>
    </div>

    <div class="panel">
      <iframe id="preview" title="Preview"></iframe>
    </div>
  </main>
</div>

<!-- Load registries & managers BEFORE engine.js -->
<script src="../engine/registry.js"></script>
<script src="../engine/theme-manager.js"></script>
<script src="../engine/template-manager.js"></script>
<script src="../engine/engine.js"></script>

<!-- Tiny offline QR (very small implementation) -->
<script>
/* Minimal QR painter wrapper using a tiny inline encoder (byte-wise L version).
   For production you may replace with qrcode.js, but this keeps file self-contained. */
function drawSimpleQR(canvas, text){
  // fallback if no canvas
  if(!canvas || !canvas.getContext) return;
  // Use a very small â€œpoor-manâ€™sâ€ encoder by drawing a checker pattern + text center,
  // so it still shows something offline. Replace with qrcode.js for real scan codes.
  // ---- Replace this with a proper QR encoder later. ----
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,W,H);
  ctx.fillStyle = '#000';
  // border
  ctx.lineWidth = 4; ctx.strokeRect(2,2,W-4,H-4);
  // fake finder squares
  const s=26;
  [['#000',8,8],['#000',W-8-s,8],['#000',8,H-8-s]].forEach(([c,x,y])=>{
    ctx.fillStyle=c; ctx.fillRect(x,y,s,s); ctx.fillStyle='#fff'; ctx.fillRect(x+6,y+6,s-12,s-12); ctx.fillStyle=c; ctx.fillRect(x+10,y+10,s-20,s-20);
  });
  // text hash pattern for uniqueness
  let h=0; for(let i=0;i<text.length;i++){h=(h*31+text.charCodeAt(i))>>>0;}
  for(let y=0;y<40;y++)for(let x=0;x<40;x++){
    const bit=((h>>((x+y)%24))&1)^(x*y%3==0?1:0);
    if(bit){ ctx.fillRect(40+x*2,40+y*2,2,2); }
  }
}
</script>

<script>
(function(){
  const $id = (id)=>document.getElementById(id);
  const on = (el,ev,fn)=>el&&el.addEventListener(ev,fn);

  // Wire buttons from owner sidebar to engine.js functions
  on($id('jsonFile'),'change', e => {
    // reuse engine.js loader
    const file = e.target.files?.[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = ()=>{ try{ setMenuData(JSON.parse(r.result)); }catch(err){ alert('Invalid JSON: '+err.message);} };
    r.readAsText(file);
  });

  on($id('loadSampleBtn'),'click', async ()=>{
    try{ const res = await fetch('../data/sample.json'); setMenuData(await res.json()); }catch(e){ alert('Could not load sample.json');}
  });

  on($id('downloadJsonBtn'),'click', ()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(window.menuData||{},null,2)],{type:'application/json'})); a.download='menu.json'; a.click(); URL.revokeObjectURL(a.href);});
  on($id('validateBtn'),'click', ()=>{ if(window.validateAndClean) validateAndClean(); else alert('Validate not found');});
  on($id('clearCacheBtn'),'click', ()=>{ localStorage.clear(); alert('Cache cleared'); });

  // brand quick edit binds (engine.js reads these ids on render())
  ['brandName','brandAddress','brandPhone','brandWhatsapp','brandHours'].forEach(id=>{
    on($id(id),'input', ()=> { if(window.menuData){ const r=(window.menuData.restaurant ||= {}); r.name=$id('brandName')?.value||r.name; r.address=$id('brandAddress')?.value||r.address; r.phone=$id('brandPhone')?.value||r.phone; r.whatsapp=$id('brandWhatsapp')?.value||r.whatsapp; r.hours=$id('brandHours')?.value||r.hours; }});
  });

  on($id('renderBtn'),'click', ()=> window.render && render());

  // sections + items (engine.js provides helpers for select/table ids)
  on($id('sectionSelect'),'change', e=>{ if(window.buildItemsTable) buildItemsTable(Number(e.target.value)||0); });
  on($id('saveItemsBtn'),'click', ()=>{ const idx=Number($id('sectionSelect')?.value||0); if(window.updateItemsFromTable){ updateItemsFromTable(idx); render(); } });

  // bulk price edit
  on($id('applyBulkBtn'),'click', ()=>{
    const pct = Number($id('bulkPct')?.value||0);
    const rnd = $id('bulkRound')?.value||'none';
    const secIx = Number($id('sectionSelect')?.value||0);
    const sec = window.menuData?.sections?.[secIx];
    if(!sec) return alert('No section selected');
    (sec.items||[]).forEach(it=>{
      let p = Number(it.price||0);
      p = p + (p*pct/100);
      if(rnd!=='none'){ const n=Number(rnd); p = Math.round(p/n)*n; }
      it.price = Math.max(0, Math.round(p));
    });
    if(window.buildItemsTable) buildItemsTable(secIx);
    render();
  });

  // CTAs + QR
  function waNumber(){ return (window.menuData?.restaurant?.whatsapp||'').replace(/[^\d]/g,''); }
  function mapsLink(){ return window.menuData?.restaurant?.locationLink || $id('locationLink')?.value || ''; }

  on($id('openWaBtn'),'click', ()=>{
    const num = waNumber();
    if(!num) return alert('Add WhatsApp number first.');
    window.open('https://wa.me/'+num, '_blank');
  });
  on($id('openLocBtn'),'click', ()=>{
    const link = mapsLink(); if(!link) return alert('Add Google Maps link first.'); window.open(link, '_blank');
  });
  on($id('shareLocBtn'),'click', ()=>{
    const nm = window.menuData?.restaurant?.name || 'Restaurant';
    const link = mapsLink();
    if(!link) return alert('Add Google Maps link first.');
    window.open('https://wa.me/?text='+encodeURIComponent(`ðŸ“ ${nm} location: ${link}`),'_blank');
  });

  // paint QR for maps link (or menu URL if hosted)
  function paintQR(){
    const canvas = $id('qrCanvas');
    const data = mapsLink() || (location.href.replace('/owner/index.html','/engine/index.html'));
    drawSimpleQR(canvas, data);
  }
  on($id('locationLink'),'input', ()=>paintQR());
  setTimeout(paintQR, 50);

  // top bar bindings to engine.js
  ['templateSelect','themeSelect','langSelect'].forEach(id=>{
    const el=$id(id); el&&el.addEventListener('change', ()=>{ if(window.render) render(); });
  });

  // initial auto-load (engine.js autoload will take care)
  setTimeout(()=>{ if(window.buildItemsTable){ buildItemsTable(0); } }, 300);
})();
</script>
</body>
</html>
